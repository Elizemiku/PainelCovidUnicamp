---
title: "Painel Covid Unicamp - AM091"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
    highlight: pygments
    social: menu
    navbar:  
      - {title: "Github", icon: fa-github, href: https://github.com/Elizemiku/PainelCovidUnicamp}
    includes:
      after_body: footer.html
---

<!-- cores e estilos em html pra dashboard -->
<!-- deixei branco mas se quiserem podemos mudar depois-->

<style>

.colored {
background-color: #ffccff;
} 

.first-box {
  background-color: #ffccff;
  color: black;
}

body {background-color: white;}
.navbar {
  class="navbar navbar-dark bg-primary";
}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    color: black;
    background-color: #66a3ff;
}

.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: black;
  background-color:#66a3ff;
}

.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #66a3ff;
}

.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #66a3ff;
}
</style>


<!-- codigo da dashboard -->

```{r setup, include=FALSE}
# bibliotecas utilizadas 
library("tidyverse")
library("plotly")
library("flexdashboard")
library("DT")
library("shiny")
library("geobr")
library("gganimate")
library("rsconnect")

# opcoes das tabelas DT, caso usemos e do codigo
# options(knitr.duplicate.label = 'allow', 
#         dplyr.summarise.inform = FALSE,
#         DT.options = list(
#           initComplete = JS(
#             "function(settings, json) 
#             {","$(this.api().table().header()).css({'background-color': '#1d80e2  ',
#             'color': 'white'});","}"
#             ),
#           pageLength = 5,
#           language = list(search = 'Busca:'),
#           lengthMenu = c(5, 10, 15, 20)
# ))

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

<!-- podemos criar um chunk pegando os codigos do twitter do R script  -->

```{r code = readLines("rtweet_ex.R") , echo = FALSE, eval = FALSE}
# coloquei eval pra nao rodar por enquanto
```

```{r, results='hide'}
#Dados da Covid-19 no Estado de SP
link <- "https://raw.githubusercontent.com/seade-R/dados-covid-sp/master/data/dados_covid_sp.csv"
covid <- read_csv2(link)

# deixando o nome das colunas bonitinhos
covid <- covid %>% 
  rename("Semana_epidemiológica" = semana_epidem, 
         "Cidade" = nome_munic, "mês" = mes, "óbitos" = obitos, 
         "óbitos_novos" = obitos_novos)

#Dados da Dengue


#Dados da SRAG
```

Covid-19 {data-navmenu="Análise de dados" data-icon="fa-allergies"}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}

# seleção das Cidades
selectInput(
  inputId = "Cidade", 
  label = "Cidades", 
  choices = c(covid$Cidade),
  selected = "Campinas",
  multiple = TRUE)

# seleção do tipo de gráfico
 selectInput(
   inputId = "Graficos", 
   label = "Gráficos", 
   choices = c("Barras","Linhas"), 
   selected = "Linhas",
   multiple = FALSE)

# seleção do eixo x
 selectInput(
   inputId = "Opcao", 
   label = "Opções", 
   choices = c("Semana_epidemiológica","datahora","mês"), 
   selected = "Semana_epidemiológica",
   multiple = FALSE)
   
# seleção do eixo y 
selectInput(
  inputId = "ObitosCasos", 
  label = "Informação", 
  choices = c("óbitos","casos", "casos_novos", "óbitos_novos"), 
  selected = "casos",
  multiple = FALSE)

```

Outputs
-----------------------------------------------------------------------

### Grafico de Casos de Covid

```{r}
# filtro reativo das cidades 

filtro_cidades <- reactive({
  
  # ver o que fazer com a variavel dias
  # if(input$Opcao == "dia"){
  #   covid %>%  filter(Cidade %in% input$Cidade) %>%
  #     group_by(dia, mes) 
  # } 
  # else{
  
    covid %>%  filter(Cidade %in% input$Cidade) 
    
})

# graficos 
output$plotly <- renderPlotly({

  if(input$Graficos == "Linhas"){
    # grafico de linhas interativo
    # numero de opcoes do eixo y por opcoes do eixo x
    ggplotly(
      ggplot(filtro_cidades(), 
             aes_string(x = input$Opcao, y = input$ObitosCasos)) +
      geom_line(aes(color =  Cidade)) +
      labs(title = "Covid-19 por Cidade",
           x = paste("Por", input$Opcao, sep = " "),
           y = paste("Número de", input$ObitosCasos, sep = " ")) +
      theme_bw()
      ) 
  }
  
  else if(input$Graficos == "Barras"){
    # grafico de barras interativo
    # numero de opcoes do eixo y por opcoes do eixo x
    ggplotly(
      ggplot(filtro_cidades(), 
             aes_string(x = input$Opcao, y = input$ObitosCasos)) +
      geom_bar(stat="identity", position = "dodge", aes(fill = Cidade)) +
      labs(title = "Covid-19 por Cidade", 
           x = paste("Por", input$Opcao, sep = " "),
           y = paste("Número de", input$ObitosCasos, sep = " ")) + 
      theme_bw()
      ) 
    }
})

plotlyOutput('plotly')

```

Covid e outras doenças {data-navmenu="Análise de dados" data-icon="fa-search"}
=====================================  

Covid-19 {data-navmenu="Dados utilizados"  data-icon="fa-notes-medical"}
===================================== 

```{r}

# tabela dados de covid de campinas 
# datatable(
#   covid %>% filter(Cidade == "Campinas"),
#   colnames = c('ID' = 1),
#   caption =  htmltools::tags$caption(
#     style = 'caption-side: top; text-align: left; color:blue; font-size: 16px',
#     'Tabela 1: ',
#     htmltools::em('Dados da Covid-19 utilizados para as análises',)
#   ),
#   class = c('cell-border stripe'),
#   extensions = c('Buttons'),
#   options = list(dom = 'Bfrtip',
#                  buttons = c('csv', 'excel', 'print'))
# )
```

Dengue {data-navmenu="Dados utilizados" data-icon="fa-notes-medical"}
===================================== 
```{r}

```

SRAG {data-navmenu="Dados utilizados" data-icon="fa-notes-medical"}
===================================== 
```{r}

```

Evolução (Mapa animado) {data-navmenu="Extras" data-icon="fa-map-marker"}
=====================================  

<!-- coloquei aqui pra ficar mais organizado  -->

```{r, results='hide'}
#Shapefile do estado de SP com divisão de municípios
mapa <- read_municipality(code_muni = 35, year = 2018)

#Pegando somente as regiões de saúde
regioes <- covid %>% drop_na() %>% select(nome_drs) %>% unique() %>% unlist() %>% unname()
#Adiciono Santos e São Paulo, pois suas regiões estão como baixada santista e grande São Paulo
regioes <- c(regioes, "Santos", "São Paulo")

#Crio um df com o nome do município + coordenadas
covid_regioes <- covid %>% 
  drop_na() %>% 
  select(Cidade, latitude, longitude) %>% 
  filter(Cidade %in% regioes) %>% 
  unique()

#Crio um df com o total da covid (casos e óbitos) por data e por região.
evolucao_casos <- covid %>% 
  group_by(datahora, nome_drs) %>% 
  summarise(casos_regiao = sum(casos), pop_regiao = sum(pop), obitos_regiao = sum(`óbitos`)) %>%
  ungroup() %>% 
  #Altero o nome das regiões para as referentes cidades antes da junção dos dados
  mutate(nome_drs = replace(nome_drs, nome_drs == "Grande São Paulo", "São Paulo")) %>% 
  mutate(nome_drs = replace(nome_drs, nome_drs == "Baixada Santista", "Santos")) %>% 
  left_join(covid_regioes, by = c("nome_drs" = "Cidade")) %>% 
  drop_na()

#Mapa
cidades <- "1-Araçatuba 2-Araraquara 3-Santos 4-Barretos 5-Bauru 6-Campinas 7-Franca 8-São Paulo \n9-Marília 10-Piracicaba 11-Presidente Prudente 12-Registro 13-Ribeirão Preto \n14-São João da Boa Vista 15-São José do Rio Preto 16-Sorocaba 17-Taubaté"

p <- ggplot(evolucao_casos) + 
  geom_sf(data = mapa, fill = "cyan4", color="black", size=.15, ) +
  geom_point(aes(x = longitude, y = latitude, group = nome_drs, 
                 size = 100000*(casos_regiao/pop_regiao),
                 color = 100000*(casos_regiao/pop_regiao)), alpha = .5) +
  scale_size_continuous(range = c(1, 15)) +
  scale_color_gradient(low = "darkgoldenrod1", high = "brown3")+
  guides(color=guide_legend(title = "Casos por 100.000 hab."), 
         size = guide_legend(title = "Casos por 100.000 hab."))+
  labs(title = "Evolução da Covid-19 em São Paulo", 
       subtitle = "{frame_time}",
       caption = cidades) +
 annotate(geom = "text", 
         x = evolucao_casos$longitude %>% unique(),
         y = evolucao_casos$latitude %>% unique(),
         label = as.character(1:17),
         size = 5) +
  theme_void() +
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
        plot.caption = element_text(size = 12, hjust = 0.5), 
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  shadow_mark() +
  transition_time(datahora)

sp_novos <- covid %>% group_by(datahora) %>% 
  summarise(novos_casos = sum(casos_novos), novos_óbitos = sum(óbitos_novos)) 

estatisticas_moveis <- function(x){
  media = rep(NA, 6)
  for(i in 7:length(x)){
    media = c(media, sum(x[i:(i-6)])/7)
  }
  return(media)
}

sp_novos <- sp_novos %>% mutate(media_casos = estatisticas_moveis(.$novos_casos),
                                media_óbitos = estatisticas_moveis(.$novos_óbitos))
#Mapa
cidades <- "1-Araçatuba 2-Araraquara 3-Santos 4-Barretos 5-Bauru 6-Campinas 7-Franca 8-São Paulo \n9-Marília 10-Piracicaba 11-Presidente Prudente 12-Registro 13-Ribeirão Preto \n14-São João da Boa Vista 15-São José do Rio Preto 16-Sorocaba 17-Taubaté"

p <- ggplot(evolucao_casos) + 
  geom_sf(data = mapa, fill = "cyan4", color="black", size=.15, ) +
  geom_point(aes(x = longitude, y = latitude, group = nome_drs, 
                 size = 100000*(casos_regiao/pop_regiao),
                 color = 100000*(casos_regiao/pop_regiao)), alpha = .5) +
  scale_size_continuous(range = c(1, 15)) +
  scale_color_gradient(low = "darkgoldenrod1", high = "brown3")+
  guides(color=guide_legend(title = "Casos por 100.000 hab."), 
         size = guide_legend(title = "Casos por 100.000 hab."))+
  labs(title = "Evolução da Covid-19 em São Paulo", 
       subtitle = "{frame_time}",
       caption = cidades) +
 annotate(geom = "text", 
         x = evolucao_casos$longitude %>% unique(),
         y = evolucao_casos$latitude %>% unique(),
         label = as.character(1:17),
         size = 5) +
  theme_void() +
  theme(plot.title = element_text(size = 16, hjust = 0.5),
        plot.subtitle = element_text(size = 14, hjust = 0.5),
        plot.caption = element_text(size = 12, hjust = 0.5), 
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  shadow_mark() +
  transition_time(datahora)

sp_novos <- covid %>% group_by(datahora) %>% 
  summarise(novos_casos = sum(casos_novos), novos_óbitos = sum(óbitos_novos)) 

estatisticas_moveis <- function(x){
  media = rep(NA, 6)
  for(i in 7:length(x)){
    media = c(media, sum(x[i:(i-6)])/7)
  }
  return(media)
}

sp_novos <- sp_novos %>% mutate(media_casos = estatisticas_moveis(.$novos_casos),
                                media_óbitos = estatisticas_moveis(.$novos_óbitos))

p1 <- ggplot(sp_novos, aes(x =datahora)) + 
  geom_line(aes(y = novos_casos), alpha = 0.5, col = "darkorange") +
  geom_line(aes(y = media_casos), col = "darkred", size = 1.5) +
  theme_bw()

p2 <- ggplot(sp_novos, aes(x =datahora)) + 
  geom_line(aes(y = novos_óbitos), alpha = 0.5, col = "darkviolet") +
  geom_line(aes(y = media_óbitos), col = "black", size = 1.5) +
  theme_bw()
```


Nuvem de palavras das autoridades {data-navmenu="Extras" data-icon="fa-hashtag"}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
# colocar em choices o dicionario que esta em rtweet_ex.R
selectInput("twitter", label = "Escolha a pessoa do twitter", 
    choices = c("Bolsonaro","Dilma"), 
    selected = "Bolsonaro",
    multiple = FALSE)
```

Outputs
-----------------------------------------------------------------------

```{r}
# chamar o codigo do twitter aqui 
# grafico 
# nuvem_de_palavras
```


Sobre {data-icon="fa-info-circle"}
=====================================  

Row
--------------------------------------------------------------

### Informações sobre este projeto { .first-box }

Painel Covid Unicamp - AM091 é um site feito para o projeto da disciplina de AM091 da Universidade Estadual de Campinas. O objetivo desse projeto constituiu-se em aproximar os alunos Elizabeth, Isabella e Vinicius do curso de Estatística na aplicação da parte prática do conhecimento estatístico, com enfoque nos dados da Covid-19 do Brasil. Além de contribuir para a aprendizagem dos alunos também é uma contribuição para o país demonstrando que todos estão se dedicando nesse tempo de Pandemia.



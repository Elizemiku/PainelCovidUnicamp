---
title: "Painel Covid Unicamp - AM091"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    source_code: embed
    highlight: pygments
    social: menu
    navbar:  
      - {title: "Github", icon: fa-github, href: https://github.com/Elizemiku/PainelCovidUnicamp}
---

<!-- cores e estilos em html pra dashboard -->
<!-- deixei branco mas se quiserem podemos mudar depois-->
<style>

.colored {
background-color: #ffccff;
}

body {background-color: white;}
.navbar {
  class="navbar navbar-dark bg-primary";
}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    color: black;
    background-color: #66a3ff;
}

.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: black;
  background-color:#66a3ff;
}

.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #66a3ff;
}

.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #66a3ff;
}

</style>


<!-- codigo da dashboard -->

```{r}
options(knitr.duplicate.label = 'allow', dplyr.summarise.inform = FALSE)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

<!-- podemos criar um chunk pegando os codigos do twitter de um R script depois -->

```{r setup, include=FALSE}
library("tidyverse")
library("plotly")
library("flexdashboard")
library("shiny")
library("geobr")
library("gganimate")
library("rsconnect")
```

```{r, results='hide'}
#Dados da Covid-19 no Estado de SP
link <- "https://raw.githubusercontent.com/seade-R/dados-covid-sp/master/data/dados_covid_sp.csv"
covid <- read_csv2(link)

#Dados da Dengue


#Dados da SRAG
```

Covid-19 {data-navmenu="Análise de dados" data-icon="fa-allergies"}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
# tirei a opcao de escolher os dados porque podemos usar as abas das paginas para separar , ai depois vcs votam na melhor opcao haha

# seleção das Cidades
# seleção das Cidades
selectInput(
  inputId = "nome_munic", 
  label = "Cidades", 
  choices = c(covid$nome_munic),
  selected = "Campinas",
  multiple = TRUE)

 selectInput(
   inputId = "Graficos", 
   label = "Gráficos", 
   choices = c("Barras","Linhas"), 
   selected = "Linhas",
   multiple = FALSE)

 selectInput(
   inputId = "Opcao", 
   label = "Opções", 
   choices = c("semana_epidem","dia","mes"), 
   selected = "seman_epidem",
   multiple = FALSE)
   
selectInput(
  inputId = "ObitosCasos", 
  label = "Informação", 
  choices = c("obitos","casos"), 
  selected = "casos",
  multiple = FALSE)
```

Outputs
-----------------------------------------------------------------------

### Grafico de Casos de Covid

```{r}
# filtro reativo das cidades 
filtro_cidades <- reactive({
  covid %>%  filter(nome_munic %in% input$nome_munic)
})

## Posso usar esse get pra transformar mas depois preciso mudar o eixo x
## ver consegue automatizar o subtitulo
## perguntar pro vini se esses graficos tao certos se a gente poe dia e mes mesmo
output$plotly <- renderPlotly({

  if(input$Graficos == "Linhas"){
    ggplotly(
      ggplot(filtro_cidades(), 
             aes(x= get(input$Opcao), 
                 y = get(input$ObitosCasos), 
                 color =  nome_munic)) +
      geom_line() +
      labs(title = "Covid-19 por Cidade", 
           subtitle = "Por semanas epideomiológicas") +
      theme_bw())
  }
  
  # so um exemplo pra ver se funciona
  else if(input$Graficos == "Barras"){
    ggplotly(
      ggplot(filtro_cidades(), 
             aes(x = dia, y = casos, fill= nome_munic)) +
      geom_bar(stat="identity", position = "dodge") +
      theme_bw()) 
    }
})

plotlyOutput('plotly')

```

Covid e outras doenças {data-navmenu="Análise de dados" data-icon="fa-search"}
=====================================  

Covid-19 {data-navmenu="Dados utilizados"  data-icon="fa-notes-medical"}
===================================== 

Dengue {data-navmenu="Dados utilizados" data-icon="fa-notes-medical"}
===================================== 

SRAG {data-navmenu="Dados utilizados" data-icon="fa-notes-medical"}
===================================== 

Evolução (Mapa animado) {data-navmenu="Extras" data-icon="fa-map-marker"}
=====================================  

<!-- coloquei aqui pra ficar mais organizado  -->

```{r, results='hide'}
#Shapefile do estado de SP com divisão de municípios
mapa <- read_municipality(code_muni = 35, year = 2018)

#Pegando somente as regiões de saúde
regioes <- covid %>% drop_na() %>% select(nome_drs) %>% unique() %>% unlist() %>% unname()
#Adiciono Santos e São Paulo, pois suas regiões estão como baixada santista e grande São Paulo
regioes <- c(regioes, "Santos", "São Paulo")

#Crio um df com o nome do município + coordenadas
covid_regioes <- covid %>% 
  drop_na() %>% 
  select(nome_munic, latitude, longitude) %>% 
  filter(nome_munic %in% regioes) %>% 
  unique()

#Crio um df com o total da covid (casos e óbitos) por data e por região.
evolucao_casos <- covid %>% 
  group_by(datahora, nome_drs) %>% 
  summarise(casos_regiao = sum(casos), pop_regiao = sum(pop), obitos_regiao = sum(obitos)) %>%
  ungroup() %>% 
  #Altero o nome das regiões para as referentes cidades antes da junção dos dados
  mutate(nome_drs = replace(nome_drs, nome_drs == "Grande São Paulo", "São Paulo")) %>% 
  mutate(nome_drs = replace(nome_drs, nome_drs == "Baixada Santista", "Santos")) %>% 
  left_join(covid_regioes, by = c("nome_drs" = "nome_munic")) %>% 
  drop_na()

#Mapa
mapa_ani <- ggplot(evolucao_casos) + 
  geom_sf(data = mapa, fill = "cyan4", color="black", size=.15, ) +
  geom_point(aes(x = longitude, y = latitude, group = nome_drs, 
                 size = 100000*(casos_regiao/pop_regiao),
                 color = 100000*(casos_regiao/pop_regiao)), alpha = .5) +
  scale_size_continuous(range = c(4, 12)) +
  scale_color_gradient(low = "darkgoldenrod1", high = "brown3")+
  guides(color=guide_legend(title = "Casos por 100.000 hab."), 
         size = guide_legend(title = "Casos por 100.000 hab."))+
  theme_void()+
  labs(title = "Evolução da Covid-19 em São Paulo")

#Vou mexer mais na animação amanhã 






# output$mapa_animado <- renderImage({
# 
#     mapa_ani 
# 
# })
# 
# imageOutput('mapa_animado')
```


Nuvem de palavras das autoridades {data-navmenu="Extras" data-icon="fa-hashtag"}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r}
selectInput("twitter", label = h4("Escolha a pessoa do twitter"), 
    choices = c("Bolsonaro","Dilma"), 
    selected = "Bolsonaro",
    multiple = FALSE)
```

Sobre {data-icon="fa-info-circle"}
=====================================  


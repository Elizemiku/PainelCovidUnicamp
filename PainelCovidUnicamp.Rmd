---
title: "Painel Covid Unicamp - AM091"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
    highlight: pygments
    social: menu
    navbar:
    - title: Github
      icon: fa-github
      href: https://github.com/Elizemiku/PainelCovidUnicamp
    includes:
      after_body: footer.html
resource_files:
- tweet.R
---

<!-- cores e estilos em html pra dashboard -->
<!-- deixei branco mas se quiserem podemos mudar depois-->

<style>

.colored {
background-color:#eeb4b4;
color: #002633
} 

body {background-color:#eeb4b4;}

.navbar {
  background-color: #80002a;
}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    color: black;
    background-color: #ffc34d;
}

.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: black;
  background-color:#ffc34d;
}

.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #ffc34d;
}

.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #ffc34d;
}

</style>


<!-- codigo da dashboard -->

```{r}
source("tweet.R")
```

```{r setup, include=FALSE}
# bibliotecas utilizadas 
library("tidyverse")
library("plotly")
library("flexdashboard")
library("shiny")
library("shinyWidgets")
library("DT")
library("geobr")
library("gganimate")
library("rsconnect")
# opcoes das tabelas DT, caso usemos e do codigo
options(knitr.duplicate.label = 'allow',
        dplyr.summarise.inform = FALSE,
        DT.options = list(
          initComplete = JS(
            "function(settings, json)
            {","$(this.api().table().header()).css({'background-color': '#1d80e2  ',
            'color': 'white'});","}"
            ),
          pageLength = 5,
          language = list(search = 'Busca:'),
          lengthMenu = c(5, 10, 15, 20)
))
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

<!-- podemos criar um chunk pegando os codigos do twitter do R script  -->


```{r, results='hide'}
#Dados da Covid-19 no Estado de SP
link <- "https://raw.githubusercontent.com/seade-R/dados-covid-sp/master/data/dados_covid_sp.csv"
covid <- read_csv2(link)
# deixando o nome das colunas bonitinhos
covid <- covid %>% 
  rename("Semana_epidemiológica" = semana_epidem, 
         "Cidade" = nome_munic, "mês" = mes, "óbitos" = obitos, 
         "óbitos_novos" = obitos_novos, "Dia" = datahora)
#Dados da Dengue
#Dados da SRAG
```

Covid-19 {data-navmenu="Análise de dados" data-icon="fa-allergies"}
=====================================  

Inputs {.sidebar data-width=250}
-----------------------------------------------------------------------

```{r sidebar_painel}
p(strong(h3("Seja Bem-Vindo!")))

# seleção das Cidades
pickerInput(
  inputId = "Cidade", 
  label = "Cidades do Estado de São Paulo:", 
  choices = c(unique(covid$Cidade)),
  selected = "Campinas",
  multiple = TRUE,
  options = list(title ='Selecione uma Cidade',`max-options` = 5)
  )

# seleção do tipo de gráfico
pickerInput(
   inputId = "Graficos", 
   label = "Tipo de gráfico:", 
   choices = c("Barras","Linhas"), 
   selected = "Linhas",
   multiple = FALSE,
   options = list(title='Selecione o tipo de Gráfico')
   )

# seleção do eixo x
pickerInput(
   inputId = "Opcao", 
   label = "Formatos de data:", 
   choices = c("Dia", "Semana_epidemiológica", "mês"), 
   selected = "Dia",
   multiple = FALSE,
   options = list(title='Selecione o tipo da Data')
  )
   
# seleção do eixo y 
pickerInput(
  inputId = "ObitosCasos", 
  label = "Tipo de ocorrência:", 
  choices = c("casos", "casos_novos", "óbitos", "óbitos_novos"), 
  selected = "casos",
  multiple = FALSE,
  options = list(title='Selecione o tipo de ocorrência')
  )
```

Outputs
-----------------------------------------------------------------------

### Gráficos da Covid-19

```{r graficos_covid}
# filtro reativo das cidades 
filtro_cidades <- reactive({
    covid %>%  filter(Cidade %in% input$Cidade) 
})

# graficos 

output$plotly <- renderPlotly({
  
  # para evitar de aparecer mensagem de erro ao não selecionar
  # nenhuma cidade
  if(is.null(input$Cidade)){
    return()
  }
  
  # gera o grafico
  else{
      if(input$Graficos == "Linhas"){
      # grafico de linhas interativo
      # numero de opcoes do eixo y por opcoes do eixo x
      ggplotly(
        ggplot(filtro_cidades(), 
               aes_string(x = input$Opcao, y = input$ObitosCasos)) +
        geom_line(aes(color =  Cidade)) +
        labs(title = "Covid-19 por Cidade",
             x = paste("Por", input$Opcao, sep = " "),
             y = paste("Número de", input$ObitosCasos, sep = " ")) +
         theme(axis.line = element_line(colour = "black"),
               panel.background = element_rect(fill = "white", size = 2),
               panel.grid.major = element_line(colour = "gray",
                                               size = 1,
                                               linetype = "solid"),
               panel.grid.minor = element_line(colour = "gray",
                                               size = 1,
                                               linetype = "solid"))) %>%
      layout(legend = list(orientation = 'h', x = 0.2, y = 1.1))
    }
  
    else if(input$Graficos == "Barras"){
      # grafico de barras interativo
      # numero de opcoes do eixo y por opcoes do eixo x
      ggplotly(
        ggplot(filtro_cidades(), 
               aes_string(x = input$Opcao, y = input$ObitosCasos)) +
        geom_bar(stat="identity", position = "dodge", aes(fill = Cidade)) +
        labs(title = "Covid-19 por Cidade", 
             x = paste("Por", input$Opcao, sep = " "),
             y = paste("Número de", input$ObitosCasos, sep = " ")) + 
        theme(axis.line = element_line(colour = "black"),
              panel.background = element_rect(fill = "white", size = 2),
              panel.grid.major = element_line(colour = "gray",
                                              size = 1,
                                              linetype = "solid"),
              panel.grid.minor = element_line(colour = "gray",
                                              size = 1,
                                              linetype = "solid"))) %>%
      layout(legend = list(orientation = 'h', x = 0.2, y = 1.1))
      }
  }
})

plotlyOutput('plotly')
```

> Gráfico de dados da Covid-19 até a presente data.

Covid e outras doenças {data-navmenu="Análise de dados" data-icon="fa-search"}
=====================================  

Row{.tabset}
--------------------------------------------------------------

### SRAG - Casos



\newline

```{r}
p('Queremos ilustrar o impacto da Covid-19 nas estatísticas de Síndrome Respiratória Aguda Grave (SRAG). Para isso, temos os dados da SRAG no estado de SP no ano de 2019 e os dados da SRAG no estado até o começo de Agosto deste ano.') 

p('Sobre a SRAG temos este trecho do boletim epidemiológico feito pelo Núcleo de Vigilância Epidemiológica Hospitalar com a Santa Casa de Misericórdia de Goiânia: "Dentre os principais agentes etiológicos que resultam em SRAG, estão os vírus (influenza A, dengue, vírus sincicial respiratório, adenovírus, hantavírus e coronavírus), e outros agentes (pneumococos,outrasbactérias, Legionella sp., leptospirose, etc.')

p('... Considera-se caso suspeito de SRAG todos os indivíduos de qualquer idade com doença respiratória aguda caracterizada por febre superior a 38ºC, tosse e dispneia, acompanhadas ou não de dor de garganta ou manifestações gastrointestinais. Além disso, devem ser observados os seguintes sinais e sintomas: aumento d afrequência respiratória (>25 rpm) e hipotensão em relação à pressão arterial habitual do paciente. Em crianças, acrescentam-se os seguintes sintomas: batimentos de asa de nariz, cianose, tiragem intercostal,desidratação e inapetência"')

srag19 <- read_csv("dados/srag2019.csv")
srag20 <- read.csv("dados/srag2020.csv")

srag20$DT_NOTIFIC <- as.Date(srag20$DT_NOTIFIC, "%Y-%m-%d")

estatisticas_moveis <- function(x){
  media = rep(NA, 6)
  for(i in 7:length(x)){
    media = c(media, sum(x[i:(i-6)])/7)
  }
  return(media)
}

srag19_20 <- tibble(ANO = c("2019", "2020"), CASOS = c(nrow(srag19), nrow(srag20)))

ggplot(srag19_20) +
  geom_col(aes(x = ANO, y = CASOS), fill = "darkred", col = "black")+
  labs(x = "Ano", y = "Total de casos", title = "Síndrome Respiratória Aguda Grave", 
       subtitle = "Casos de SRAG no Estado de São Paulo",
       caption = "Fonte: DataSUS")+
  theme_bw()
```

### SRAG - Causas


```{r}
p('Existe uma diferença colossal no número de complicações respiratórias no estado de São Paulo - e em todo Brasil, para ser mais correto - e nem chegamos ao final de 2020, definitivamente o termo "gripezinha" (ilação do presidente, inclusive) não reflete a gravidade do problema que estamos enfrentando. ')

srag20 <- srag20 %>% mutate(DUMMY = 1) %>% group_by(DT_NOTIFIC, CLASSI_FIN, EVOLUCAO, SEM_NOT) %>% 
  summarise(Casos = sum(DUMMY)) %>% 
  rename("Causa" = CLASSI_FIN, "Data" = DT_NOTIFIC, "Evolucao" = EVOLUCAO, "Semana" = SEM_NOT)

## Reorder fullname based on the the sum of the other columns
srag20$Causa <- reorder(srag20$Causa, rowSums(srag20[-1]))

ggplot(srag20, aes(x = Semana, y = Casos, fill = as.factor(Causa))) +
  geom_bar(position = "stack", stat = "identity") +
  theme_bw() +
  labs(title = "Causas da SRAG em 2020",
       subtitle = "Casos semanais agrupados pela causa", 
       caption = "Fonte: DataSUS") +
  scale_fill_discrete(name = "Causa", labels = c("Influenza", "Outro Vírus Respiratório", "Outro Agente Etiológico", "SRAG não especificado", "COVID-19", "Info. faltante"))

p('Podemos ver claramente a influência da Covid-19 na contabilização dos casos, sem contar que temos nesta classificação ainda SRAG não especificado (o Brasil tem uma taxa baíxissima de testes, média de 2,28 para cada 100 mil habitantes [1]) e temos dados faltantes no preenchimento da ficha.')
```

### Dengue

```{r}
ev_dengue <- read_csv2("dados/evolucao_dengue.csv")

covid_comp <- covid %>% filter(Dia == Sys.Date()) %>% summarise(Casos = sum(casos), Obitos = sum(óbitos))

covid_dengue <- tibble(Doença = c("Dengue", "Covid-19"),
                       Casos = c(ev_dengue$Total[1], covid_comp[1] %>% unlist() %>% unname()),
                        Obitos = c(ev_dengue$`?bito pelo agravo notificado`[1], covid_comp[2] %>% unlist() %>% unname()))

covid_dengue <- covid_dengue %>% pivot_longer(-Doença, names_to = "Ocorrência", values_to = "Quantidade")

ggplot(covid_dengue, aes(x = Doença, y = Quantidade, fill = `Ocorrência`)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  scale_fill_manual(values = c("salmon", "black"))+
  labs(title = "Dengue x Covid-19", subtitle = "Estatísticas de casos registrados e óbitos em decorrência de dengue durante todo o ano de 2019 e Covid-19 até o presente momento")
```

Uma (infelizmente) velha conhecida dos brasileiros é a dengue, podemos ver que a arbovirose também é bem menos letal que a Covid-19, enquanto a dengue tem uma letalidade registrada de aproximadamente 0,05% no estado de São Paulo, a doença do Coronavírus tem uma letalidade em torno de 3%.


Gráficos animados {data-icon="fa-chart-line"}
=====================================  

Row 
-------------------------------------
    
### Mapa do estado de SP
<img src="https://raw.githubusercontent.com/Elizemiku/PainelCovidUnicamp/master/dados/evolucao.gif" alt="mapa"/>    

Row {.tabset .tabset-fade}
-------------------------------------
   
### Incidência

<img src="https://raw.githubusercontent.com/Elizemiku/PainelCovidUnicamp/master/dados/casos.gif" alt="incidencia"/>

### Óbitos
    
<img src="https://raw.githubusercontent.com/Elizemiku/PainelCovidUnicamp/master/dados/mortes.gif" alt="obitos"/>

Nuvem de palavras dinâmica {data-icon="fa-hashtag"}
=====================================  

Inputs {.sidebar}
-----------------------------------------------------------------------

### Contas de algumas autoridades do País

```{r}
library("rtweet")
library("tidyverse")
library("wordcloud2")
library("httpuv")

#Keys de acesso
api_key <- "QVbudD80ms2yc0FyOrzSd74Jq"
api_secret_key <- "G8XGjoY91NoZ42fcweONb9iKmXLe0WkLf8U4ReeK4smDaFnk8x"
access_token <- "143947934-hy5cYTCLZ14rW0UngS23sZeDNMI4TFS28xCDhsqA"
access_token_secret <- "oU1tHKERX7NfrxzVz7jTuoT4YPf1KuLjzcnhp6S4bxvNX"

##authenticate via web browser
token <- create_token(
  app = "PainelCovidUnicamp",
  consumer_key = api_key,
  consumer_secret = api_secret_key,
  access_token = access_token,
  access_secret = access_token_secret)

#Palavras de interesse
dicionario <- c("corona", "covid", "quarentena", "lockdown", "cloroquina", "casos", "ministros" ,"colapso",
                "respiradores","isolamento horizontal","isolamento vertical","quarentena","hospital",
                "campanha","isolamento social","distanciamento social","máscara", "epidemia",
                "pandemia","contágio","confinamento","assintomático","OMS","saúde pública",
                "pico","UTI","comorbidade","obesidade","diabete","doenças respiratórias",
                "doenças do coração","cardíacos","diabéticos","pneumonia","vacina",
                "casa","idosos","crianças","medidas","economia","Manaus","São Paulo",
                "Rio de Janeiro","febre","dor de cabeça","saudade","luto","mortes","óbitos",
                "aglomeração","casos graves","suspeita","casos confirmados","testes",
                "subnotificação","solidariedade","doações","cestas básicas","risco","epicentro",
                "comércio","home office","hospitais de campanha","auxílio emergencial","fique em casa",
                "desemprego","empresários","Brasil","China","Itália","Estados Unidos","Espanha",
                "França","suspensão do contrato de trabalho","leitos","países","infecção",
                "contágio","contaminados","países","casos notificados","casos confirmados",
                "casos descartados","pacientes curados","ciência","médicos","medicina",
                "pesquisadores","salário","distanciamento","governadores","dinheiro público",
                "sus","corrupção","responsabilidade","achatamento da curva","estatísticas",
                "mortalidade","letalidade","transporte público","rodízio","lotação","enfermeiros",
                "hidroxicloroquina","gripezinha","clima","cardiovascular","crise sanitária",
                "cloroquina","álcool","lavar as mãos","medidas","caos social","fome","violência doméstica",
                "cidades","favelas","microempresas","microempresário","funcionários","funcionários público",
                "Suécia","depressão","escolas","shoppings","afastamento")

dicionario <- unique(dicionario)

contas <- c("jairbolsonaro","jdoriajr","wilsonwitzel","RomeuZema","EduardoLeite_","costa_rui","	
            CarlosMoises","CamiloSantanaCE","PauloCamara40","ratinho_jr","ronaldocaiado","helderbarbalho",	
            "FlavioDino","wdiaspi","joaoazevedolins","MauroMendes40","belivaldochagas","Casagrande_ES",	
            "RenanFilho_","GovernoAlagoas","gladsoncameli","maurocarlesse","GovernoRO","celmarcosrocha",	
            "Reinaldo45psdb","waldezoficial","antoniodenarium","AbrahamWeint","DamaresAlves",	
            "PauloGuedesMin","TerezaCrisMS","SF_Moro","tarcisiogdf","OsmarTerra","indaiatubapref",	
            "prefpauliniasp","prefsp","sumaresp","pref_sorocaba","jonasdonizette_")	

pickerInput(
  inputId = "conta",
  label = "Escolha até 4 contas para descobrir quais palavras foram digitadas durante a pandemia:",
  choices = contas,
  multiple = TRUE,
  selected = "jonasdonizette_",
  options = list(`max-options` = 4, title='Selecione uma conta'))

```

Row
--------------------------------------------------------------

### Nuvem de palavras 

```{r}
filtro_contas <- reactive({
  if(is.null(input$conta)){
    return()
  }
  else{
  tibble(dicionario, freq = 
           str_count(paste(unlist(str_to_lower(as.character(
             get_timeline(input$conta, n=1000)[,"text"]))),
             collapse = " "), dicionario))
  }
})

output$nuvem <- renderWordcloud2({

wordcloud2(filtro_contas(), size=4.9, minSize = 3.9, color='random-light', backgroundColor="black")

})

wordcloud2Output("nuvem")
```

### Tabela de frenquências das palavras 
```{r}
output$tabela<- renderDataTable({

filtro_contas() %>% arrange(desc(freq))
  
})

DTOutput("tabela", height = "auto")
```


Sobre {data-icon="fa-info-circle"}
=====================================  

### Informações sobre o projeto: {.colored}

> Painel Covid Unicamp - AM091 é um site feito para o projeto da disciplina AM091 da Universidade Estadual de Campinas. O objetivo desse projeto constituiu-se em aproximar os alunos Elizabeth, Isabella e Vinícius do curso de Estatística, na aplicação da parte prática do conhecimento estatístico, com enfoque nos dados da Covid-19 no Estado de São Paulo. Este projeto, além de contribuir para a aprendizagem dos alunos também é uma contribuição para o país, demonstrando que todos estão se dedicando nesse tempo de Pandemia. <br/><br/>
> Disciplina AM091 - Proposta 5: Coleta de informações/dados, Verificação de veracidade de dados/informações. Análise de dados usando ferramentas matemáticas/estatísticas, Divulgação das informações para o publico geral. <br/><br/>
>Instituto de Matemática, Estatística e Computação Científica/ IMEEC <br/>
>Universidade de Campinas / UNICAMP

Link para os dados utilizados no Painel:

Covid:

- https://www.saopaulo.sp.gov.br/planosp/simi/dados-abertos/

Dengue:

- http://www.saude.sp.gov.br/cve-centro-de-vigilancia-epidemiologica-prof.-alexandre-vranjac/areas-de-vigilancia/doencas-de-transmissao-por-vetores-e-zoonoses/arboviroses-urbanas/dengue/dados-estatisticos

SRAG:

- https://opendatasus.saude.gov.br/dataset/bd-srag-2019 
- https://opendatasus.saude.gov.br/dataset/bd-srag-2020
